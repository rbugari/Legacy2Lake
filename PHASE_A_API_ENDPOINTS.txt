# Phase A - Column Mapping API Endpoints
# Add after line 242 in main.py (after context endpoints)

from services.column_mapping_service import ColumnMappingService, ColumnMapping

class ColumnMappingPayload(BaseModel):
    source_column: str
    source_datatype: Optional[str] = None
    target_column: Optional[str] = None
    target_datatype: Optional[str] = None
    transformation_rule: Optional[str] = None
    is_pii: bool = False
    is_nullable: bool = True
    default_value: Optional[str] = None

@app.get("/assets/{asset_id}/column-mappings")
async def get_asset_column_mappings(asset_id: str, db: SupabasePersistence = Depends(get_db)):
    """Get all column mappings for an asset"""
    service = ColumnMappingService(db.client)
    mappings = await service.get_mappings_for_asset(asset_id)
    return {"mappings": mappings}

@app.post("/assets/{asset_id}/column-mappings")
async def save_column_mapping(
    asset_id: str,
    payload: ColumnMappingPayload,
    db: SupabasePersistence = Depends(get_db)
):
    """Create or update a column mapping"""
    service = ColumnMappingService(db.client)
    mapping = ColumnMapping(
        asset_id=asset_id,
        source_column=payload.source_column,
        source_datatype=payload.source_datatype,
        target_column=payload.target_column,
        target_datatype=payload.target_datatype,
        transformation_rule=payload.transformation_rule,
        is_pii=payload.is_pii,
        is_nullable=payload.is_nullable,
        default_value=payload.default_value
    )
    result = await service.upsert_mapping(mapping)
    return {"success": True, "mapping": result}

@app.post("/assets/{asset_id}/column-mappings/bulk")
async def bulk_save_mappings(
    asset_id: str,
    mappings: List[ColumnMappingPayload],
    db: SupabasePersistence = Depends(get_db)
):
    """Bulk upsert column mappings"""
    service = ColumnMappingService(db.client)
    mapping_objs = [
        ColumnMapping(
            asset_id=asset_id,
            source_column=m.source_column,
            source_datatype=m.source_datatype,
            target_column=m.target_column,
            target_datatype=m.target_datatype,
            transformation_rule=m.transformation_rule,
            is_pii=m.is_pii,
            is_nullable=m.is_nullable,
            default_value=m.default_value
        )
        for m in mappings
    ]
    count = await service.bulk_upsert(mapping_objs)
    return {"success": True, "count": count}

@app.delete("/assets/{asset_id}/column-mappings/{source_column}")
async def delete_column_mapping(
    asset_id: str,
    source_column: str,
    db: SupabasePersistence = Depends(get_db)
):
    """Delete a specific column mapping"""
    service = ColumnMappingService(db.client)
    success = await service.delete_mapping(asset_id, source_column)
    return {"success": success}

@app.post("/assets/{asset_id}/column-mappings/suggest")
async def suggest_mapping(
    asset_id: str,
    payload: Dict[str, str],
    db: SupabasePersistence = Depends(get_db)
):
    """AI-powered mapping suggestion"""
    service = ColumnMappingService(db.client)
    suggestion = await service.suggest_mapping(
        payload.get("source_column"),
        payload.get("source_datatype")
    )
    return suggestion

@app.get("/assets/{asset_id}/pii-columns")
async def get_pii_columns(asset_id: str, db: SupabasePersistence = Depends(get_db)):
    """Get list of PII columns for an asset"""
    service = ColumnMappingService(db.client)
    pii_cols = await service.get_pii_columns(asset_id)
    return {"pii_columns": pii_cols}
