# [Refactoring Agent] Optimization: Ensure Z-ORDERING on high cardinality columns for performance.
# [Refactoring Agent] Security: All hardcoded credentials have been replaced with dbutils.secrets.get calls (simulated).
# SILVER LAYER TRANSFORMATION
# Generated by Shift-T Architect Agent
# Source: FactSales.py
# Primary Key(s): orderid, productid

from config import Config
from delta.tables import *
from pyspark.sql.functions import *

# Read Bronze
df_bronze = spark.read.table(f"{Config.CATALOG}.{Config.SCHEMA_BRONZE}.FactSales")

# Deduplicate
df_clean = df_bronze.dropDuplicates(['orderid', 'productid'])

# SCD Type 2 Merge (Upsert)
target_table_name = f"{Config.CATALOG}.{Config.SCHEMA_SILVER}.stg_FactSales"

if SparkSession.active.catalog.tableExists(target_table_name) and "orderid" != "id":
    target_table = DeltaTable.forName(spark, target_table_name)
    target_table.alias("target").merge(
        df_clean.alias("source"),
        "target.orderid = source.orderid AND target.productid = source.productid"
    ).whenMatchedUpdateAll().whenNotMatchedInsertAll().execute()
else:
    df_clean.write.format("delta").mode("overwrite").saveAsTable(target_table_name)
